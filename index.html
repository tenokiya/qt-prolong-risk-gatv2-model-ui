<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QT Prolongation Risk Predictor</title>
  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; --bg:#ffffff; --card:#f9fafb; --warn:#92400e; --warnbg:#fffbeb; --warnbd:#fde68a; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
           margin: 0; color: var(--t); background: var(--bg); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1.1fr 0.9fr; } }
    .card { border: 1px solid var(--b); background: var(--card); border-radius: 12px; padding: 14px; }
    label { display:block; font-size: 12px; color: var(--m); margin: 10px 0 6px; }
    input[type="text"], input[type="number"], select {
      width: 100%; padding: 10px; border: 1px solid var(--b); border-radius: 10px; background:#fff;
      box-sizing: border-box; font-size: 14px;
    }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1 1 auto; }
    .radio { display:flex; gap: 14px; align-items:center; flex-wrap: wrap; }
    .radio label { margin: 0; font-size: 13px; color: var(--t); display:flex; gap: 6px; align-items:center; }
    .btns { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button {
      padding: 10px 14px; border-radius: 10px; border: 1px solid var(--b);
      background: #fff; cursor: pointer; font-size: 14px;
    }
    button.primary { background: #111827; color: #fff; border-color:#111827; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .small { font-size: 12px; color: var(--m); margin-top: 8px; line-height: 1.4; }

    pre {
      margin: 0; white-space: pre-wrap; word-break: break-word; background:#fff; border:1px solid var(--b);
      border-radius: 10px; padding: 10px; font-size: 12px; overflow:auto; max-height: 520px;
    }
    table { width: 100%; border-collapse: collapse; background:#fff; border:1px solid var(--b); border-radius:10px; overflow:hidden; }
    th, td { border-bottom:1px solid var(--b); padding: 8px 10px; font-size: 12px; text-align: left; }
    th { background:#f3f4f6; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid var(--b); background:#fff; font-size: 12px; }
    .ok { color:#065f46; border-color:#a7f3d0; background:#ecfdf5; }
    .ng { color:#7c2d12; border-color:#fed7aa; background:#fff7ed; }
    .warn { color: var(--warn); border-color: var(--warnbd); background: var(--warnbg); }

    /* Summary UI */
    .summaryBox { border: 1px solid var(--b); background: #fff; border-radius: 12px; padding: 12px; }
    .summaryHead { display:flex; gap: 10px; align-items: baseline; justify-content: space-between; flex-wrap: wrap; }
    .bigLabel { font-size: 22px; font-weight: 700; letter-spacing: .2px; }
    .kv { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .kv td { border-bottom: 1px solid var(--b); padding: 8px 10px; font-size: 12px; }
    .kv td.k { color: var(--m); width: 38%; }
    details { margin-top: 10px; }
    details > summary { cursor: pointer; font-size: 12px; color: var(--m); user-select: none; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .apiNote { margin-top: 8px; display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
    .apiNote code { background:#fff; border:1px solid var(--b); border-radius: 8px; padding: 2px 6px; font-size: 12px; }
    .apiNote button { padding: 6px 10px; font-size: 12px; }
  
    /* IG chart (bar) */
    .igChart { margin-top: 10px; border: 1px solid var(--b); border-radius: 10px; background:#fff; padding: 10px; }
    .igRow { display: grid; grid-template-columns: 1fr 2fr auto; gap: 8px; align-items: center; margin: 6px 0; }
    .igFeat { font-size: 12px; color: var(--t); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .igBarWrap { position: relative; height: 10px; background:#f3f4f6; border:1px solid var(--b); border-radius: 999px; overflow: hidden; }
    .igZero { position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: var(--b); }
    .igBar { position: absolute; top: 0; bottom: 0; border-radius: 999px; background:#111827; opacity: 0.85; }
    .igBarNeg { background:#b91c1c; opacity: 0.75; }
    .igVal { font-size: 12px; color: var(--m); text-align: right; }
    @media (max-width: 520px){
      .igRow { grid-template-columns: 1fr; }
      .igVal { text-align: right; }
    }

  </style>
</head>
<body>
  <div class="wrap">
    <h1>QT延長リスク予測（SMILES / PubChem CID）</h1>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div style="flex: 1 1 220px;">
            <label>入力タイプ</label>
            <div class="radio">
              <label><input type="radio" name="itype" value="smiles" checked> SMILES</label>
              <label><input type="radio" name="itype" value="cid"> CID</label>
            </div>
          </div>
          <div style="flex: 1 1 220px;">
            <label>閾値（threshold）</label>
            <input id="thr" type="number" step="0.01" min="0" max="1" value="0.5" />
          </div>
        </div>

        <label>入力値</label>
        <input id="ival" type="text" placeholder='例: CCO / 2244 など' />

        <div class="row">
          <div>
            <label><input id="doIG" type="checkbox"> IG（Integrated Gradients）を計算する（任意）</label>
          </div>
          <div>
            <label>IG steps（大きいほど重い）</label>
            <select id="igSteps">
              <option value="8">8</option>
              <option value="16" selected>16</option>
              <option value="32">32</option>
              <option value="64">64</option>
            </select>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="runBtn">実行</button>
          <button id="resetBtn">リセット</button>
        </div>

        <div class="small">
          - IGは計算負荷が高いので、通常はOFF推奨。<br>
          - 本UIは <span class="mono">https</span> のAPI（Hugging Face Spaces）を呼び出します。<br>
        </div>

        <div class="apiNote small">
          <span>API（固定）:</span>
          <code class="mono" id="apiFixed"></code>
          <button id="copyApiBtn" type="button">コピー</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="align-items: baseline;">
          <div><span class="pill" id="statusPill">idle</span></div>
          <div style="text-align:right; font-size:12px; color:var(--m);" id="metaLine"></div>
        </div>

        <label>結果（要約）</label>
        <div id="summaryBox" class="summaryBox" style="display:none;">
          <div class="summaryHead">
            <div class="bigLabel" id="sumRisk">-</div>
            <div class="small" id="sumSub"></div>
          </div>
          <table class="kv" aria-label="summary">
            <tbody>
              <tr><td class="k">入力</td><td id="sumInput" class="mono"></td></tr>
              <tr><td class="k">canonical SMILES</td><td id="sumCan" class="mono"></td></tr>
              <tr><td class="k">確率（prob）</td><td id="sumProb"></td></tr>
              <tr><td class="k">閾値（threshold）</td><td id="sumThr"></td></tr>
              <tr><td class="k">判定（pred）</td><td id="sumPred"></td></tr>
              <tr><td class="k">logit</td><td id="sumLogit"></td></tr>
              <tr><td class="k">device</td><td id="sumDev"></td></tr>
            </tbody>
          </table>

          <details id="jsonDetails">
            <summary>詳細JSONを表示</summary>
            <pre id="outJson">{}</pre>
          </details>
        </div>

        <div id="igBox" style="display:none; margin-top: 12px;">
          <label>IG（|attribution| 上位）</label>
          <div class="small">バーは attribution の符号に応じて 0 を中心に左右へ表示します（右=正、左=負）。</div>
          <div id="igChart" class="igChart" aria-label="IG bar chart"></div>
<div class="small">注：attribution は「モデル入力空間（node特徴 + スケール済みglobal特徴）」上の値です。</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // 固定API（UIからは変更しない）
  const API_BASE = "https://te-nok-qtrisk-gatv2-model.hf.space";

  function getInputType(){
    const el = [...document.querySelectorAll('input[name="itype"]')].find(x=>x.checked);
    return el ? el.value : "smiles";
  }

  function setStatus(text, kind){
    const pill = $("statusPill");
    pill.textContent = text;
    pill.className = "pill " + (kind || "");
  }

  function pretty(obj){ return JSON.stringify(obj, null, 2); }

  async function postJson(url, body){
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch(e){ data = { raw: text }; }

    if(!res.ok){
      const err = new Error("HTTP " + res.status);
      err.status = res.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  function renderIGTop(ig){
    const box = $("igBox");

    if(!ig || !ig.top_abs){
      box.style.display = "none";
      // chartもクリア
      const chart = $("igChart");
      if(chart) chart.innerHTML = "";
      return;
    }

    renderIGChart(ig);
    box.style.display = "block";
  }

  
  function renderIGChart(ig){
    const chart = $("igChart");
    if(!chart) return;
    chart.innerHTML = "";

    if(!ig || !ig.top_abs){
      return;
    }

    const rows = ig.top_abs
      .map(r => ({ name: String(r[0]), val: Number(r[1]) }))
      .filter(o => Number.isFinite(o.val));

    if(rows.length === 0){
      return;
    }

    const maxAbs = Math.max(...rows.map(o => Math.abs(o.val)), 1e-12);

    for(const o of rows){
      const row = document.createElement("div");
      row.className = "igRow";

      const feat = document.createElement("div");
      feat.className = "igFeat";
      feat.title = o.name;
      feat.textContent = o.name;

      const wrap = document.createElement("div");
      wrap.className = "igBarWrap";

      const zero = document.createElement("div");
      zero.className = "igZero";
      wrap.appendChild(zero);

      const bar = document.createElement("div");
      const w = (Math.abs(o.val) / maxAbs) * 50; // 0-50 (% of half width)

      if(o.val >= 0){
        bar.className = "igBar";
        bar.style.left = "50%";
        bar.style.width = w.toFixed(2) + "%";
      }else{
        bar.className = "igBar igBarNeg";
        bar.style.left = (50 - w).toFixed(2) + "%";
        bar.style.width = w.toFixed(2) + "%";
      }
      wrap.appendChild(bar);

      const val = document.createElement("div");
      val.className = "igVal mono";
      val.textContent = (Math.abs(o.val) < 1e-3) ? o.val.toExponential(3) : o.val.toFixed(6);

      row.appendChild(feat);
      row.appendChild(wrap);
      row.appendChild(val);

      chart.appendChild(row);
    }
  }


  function summarizeMeta(r){
    const dev = r?.meta?.device ? `device=${r.meta.device}` : "";
    const rl  = r?.risk_label ? `risk=${r.risk_label}` : "";
    const p   = (typeof r?.prob === "number") ? `prob=${r.prob.toFixed(6)}` : "";
    return [dev, rl, p].filter(Boolean).join(" | ");
  }

  function fmtProb(prob){
    if(typeof prob !== "number") return "";
    const pct = prob * 100;
    const pctStr = (pct < 0.01) ? pct.toExponential(2) + "%" : pct.toFixed(3) + "%";
    const rawStr = (prob < 0.001) ? prob.toExponential(3) : prob.toFixed(6);
    return `${rawStr}（${pctStr}）`;
  }

  function riskClass(label){
    const v = String(label || "").toLowerCase();
    if(v === "low") return "ok";
    if(v === "medium") return "warn";
    if(v === "high") return "ng";
    return "";
  }

  function renderSummary(r, inputType, inputValue){
    $("summaryBox").style.display = "block";

    const rl = r?.risk_label ?? "-";
    $("sumRisk").textContent = `Risk: ${rl}`;
    $("sumRisk").className = "bigLabel " + riskClass(rl);

    const canonical = r?.input?.canonical_smiles ?? "";
    $("sumInput").textContent = `${inputType}: ${inputValue}`;
    $("sumCan").textContent = canonical;

    $("sumProb").textContent = fmtProb(r?.prob);
    $("sumThr").textContent = (typeof r?.threshold === "number") ? String(r.threshold) : "";
    $("sumPred").textContent = (r?.pred === 1) ? "1（リスクあり）" : (r?.pred === 0 ? "0（リスク低）" : String(r?.pred ?? ""));
    $("sumLogit").textContent = (typeof r?.logit === "number") ? (Math.abs(r.logit) >= 1000 ? String(r.logit) : r.logit.toFixed(6)) : "";
    $("sumDev").textContent = r?.meta?.device ?? "";

    $("sumSub").textContent = summarizeMeta(r);
    $("outJson").textContent = pretty(r);
  }

  // 初期化
  $("apiFixed").textContent = API_BASE;
  setStatus("idle", "");

  $("copyApiBtn").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(API_BASE);
      alert("API URLをコピーしました。");
    }catch(e){
      // clipboardが使えない環境向けフォールバック
      const ta = document.createElement("textarea");
      ta.value = API_BASE;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert("API URLをコピーしました。");
    }
  });

  $("resetBtn").addEventListener("click", ()=>{
    $("ival").value = "";
    $("doIG").checked = false;
    $("igSteps").value = "16";
    $("thr").value = "0.5";
    $("outJson").textContent = "{}";
    $("metaLine").textContent = "";
    $("summaryBox").style.display = "none";
    $("sumRisk").textContent = "-";
    $("sumSub").textContent = "";
    renderIGTop(null);
    setStatus("idle", "");
  });

  $("runBtn").addEventListener("click", async ()=>{
    const type = getInputType();
    const value = $("ival").value.trim();
    const thr = Number($("thr").value);

    if(!value){
      alert("入力値を指定してください。");
      return;
    }

    const doIG = $("doIG").checked;
    const endpoint = doIG ? "/interpret" : "/predict";
    const url = API_BASE.replace(/\/+$/,"") + endpoint;

    const body = { threshold: isFinite(thr) ? thr : 0.5 };
    if(type === "smiles"){
      body.smiles = value;
    }else{
      body.cid = String(value); // CIDは文字列で渡す
    }
    if(doIG){
      body.ig_steps = parseInt($("igSteps").value, 10);
    }

    $("runBtn").disabled = true;
    setStatus("running", "");
    $("metaLine").textContent = "";
    $("summaryBox").style.display = "none";
    renderIGTop(null);

    console.log("[QT] POST", url, body);

    try{
      const r = await postJson(url, body);
      $("metaLine").textContent = summarizeMeta(r);
      renderSummary(r, type, value);
      renderIGTop(r.ig);
      setStatus("ok", "ok");
    }catch(err){
      const payload = { message: String(err?.message || err), status: err?.status, data: err?.data };
      $("outJson").textContent = pretty(payload);
      $("summaryBox").style.display = "block";
      $("sumRisk").textContent = "Error";
      $("sumRisk").className = "bigLabel ng";
      $("sumSub").textContent = "API呼び出しに失敗しました";
      $("sumInput").textContent = `${type}: ${value}`;
      $("sumCan").textContent = "";
      $("sumProb").textContent = "";
      $("sumThr").textContent = "";
      $("sumPred").textContent = "";
      $("sumLogit").textContent = "";
      $("sumDev").textContent = "";
      setStatus("error", "ng");
      console.error("[QT] ERROR", payload);
      alert("API呼び出しに失敗しました。Console と 詳細JSON を確認してください。");
    }finally{
      $("runBtn").disabled = false;
    }
  });

  console.log("[QT] UI ready");
</script>
</body>
</html>
