<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QT Prolongation Risk Predictor</title>
  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; --bg:#ffffff; --card:#f9fafb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
           margin: 0; color: var(--t); background: var(--bg); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1.1fr 0.9fr; } }
    .card { border: 1px solid var(--b); background: var(--card); border-radius: 12px; padding: 14px; }
    label { display:block; font-size: 12px; color: var(--m); margin: 10px 0 6px; }
    input[type="text"], input[type="number"], select {
      width: 100%; padding: 10px; border: 1px solid var(--b); border-radius: 10px; background:#fff;
      box-sizing: border-box; font-size: 14px;
    }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1 1 auto; }
    .radio { display:flex; gap: 14px; align-items:center; flex-wrap: wrap; }
    .radio label { margin: 0; font-size: 13px; color: var(--t); display:flex; gap: 6px; align-items:center; }
    .btns { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button {
      padding: 10px 14px; border-radius: 10px; border: 1px solid var(--b);
      background: #fff; cursor: pointer; font-size: 14px;
    }
    button.primary { background: #111827; color: #fff; border-color:#111827; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .small { font-size: 12px; color: var(--m); margin-top: 8px; line-height: 1.4; }
    pre {
      margin: 0; white-space: pre-wrap; word-break: break-word; background:#fff; border:1px solid var(--b);
      border-radius: 10px; padding: 10px; font-size: 12px; overflow:auto; max-height: 520px;
    }
    table { width: 100%; border-collapse: collapse; background:#fff; border:1px solid var(--b); border-radius:10px; overflow:hidden; }
    th, td { border-bottom:1px solid var(--b); padding: 8px 10px; font-size: 12px; text-align: left; }
    th { background:#f3f4f6; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid var(--b); background:#fff; font-size: 12px; }
    .ok { color:#065f46; border-color:#a7f3d0; background:#ecfdf5; }
    .ng { color:#7c2d12; border-color:#fed7aa; background:#fff7ed; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>QT延長リスク予測（SMILES / PubChem CID）</h1>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div style="flex: 2 1 320px;">
            <label>API Base URL（例： http://127.0.0.1:8000 ）</label>
            <input id="apiBase" type="text" placeholder="https://te-nok-qtrisk-gatv2-model.hf.space" />
          </div>
          <div style="flex: 1 1 180px;">
            <label>入力タイプ</label>
            <div class="radio">
              <label><input type="radio" name="itype" value="smiles" checked> SMILES</label>
              <label><input type="radio" name="itype" value="cid"> CID</label>
            </div>
          </div>
        </div>

        <label>入力値</label>
        <input id="ival" type="text" placeholder='例: CCO / 2244 など' />

        <div class="row">
          <div>
            <label><input id="doIG" type="checkbox"> IG（Integrated Gradients）を計算する（任意）</label>
          </div>
          <div>
            <label>IG steps（大きいほど重い）</label>
            <select id="igSteps">
              <option value="8">8</option>
              <option value="16" selected>16</option>
              <option value="32">32</option>
              <option value="64">64</option>
            </select>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="runBtn">実行</button>
          <button id="resetBtn">リセット</button>
        </div>

        <div class="small">
          - IGは計算負荷が高いので、通常はOFF推奨。<br>
          - Pagesで公開する場合、PagesがhttpsでAPIがhttpだと混在コンテンツでブロックされます（APIもhttps化が必要）。
        </div>
      </div>

      <div class="card">
        <div class="row" style="align-items: baseline;">
          <div><span class="pill" id="statusPill">idle</span></div>
          <div style="text-align:right; font-size:12px; color:var(--m);" id="metaLine"></div>
        </div>

        <label>結果（JSON）</label>
        <pre id="outJson">{}</pre>

        <div id="igBox" style="display:none; margin-top: 12px;">
          <label>IG（|attribution| 上位）</label>
          <table id="igTopTbl">
            <thead><tr><th>feature</th><th>attribution</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="small">注：attribution は「モデル入力空間（node特徴 + スケール済みglobal特徴）」上の値です。</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function getInputType(){
    const el = [...document.querySelectorAll('input[name="itype"]')].find(x=>x.checked);
    return el ? el.value : "smiles";
  }

  function setStatus(text, kind){
    const pill = $("statusPill");
    pill.textContent = text;
    pill.className = "pill " + (kind || "");
  }

  function pretty(obj){ return JSON.stringify(obj, null, 2); }

  function saveApiBase(v){ localStorage.setItem("QT_API_BASE", v); }
  function loadApiBase(){ 
  return localStorage.getItem("QT_API_BASE") || "https://te-nok-qtrisk-gatv2-model.hf.space"; 
  }

  async function postJson(url, body){
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch(e){ data = { raw: text }; }

    if(!res.ok){
      const err = new Error("HTTP " + res.status);
      err.status = res.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  function renderIGTop(ig){
    const box = $("igBox");
    const tb = $("igTopTbl").querySelector("tbody");
    tb.innerHTML = "";

    if(!ig || !ig.top_abs){
      box.style.display = "none";
      return;
    }

    for(const row of ig.top_abs){
      const tr = document.createElement("tr");
      const td1 = document.createElement("td");
      const td2 = document.createElement("td");
      td1.textContent = row[0];
      td2.textContent = String(row[1]);
      tr.appendChild(td1);
      tr.appendChild(td2);
      tb.appendChild(tr);
    }
    box.style.display = "block";
  }

  function summarizeMeta(r){
    const dev = r?.meta?.device ? `device=${r.meta.device}` : "";
    const rl  = r?.risk_label ? `risk=${r.risk_label}` : "";
    const p   = (typeof r?.prob === "number") ? `prob=${r.prob.toFixed(6)}` : "";
    return [dev, rl, p].filter(Boolean).join(" | ");
  }

  // 初期化
  $("apiBase").value = loadApiBase();
  setStatus("idle", "");

  $("apiBase").addEventListener("change", (e)=> saveApiBase(e.target.value.trim()));

  $("resetBtn").addEventListener("click", ()=>{
    $("ival").value = "";
    $("doIG").checked = false;
    $("igSteps").value = "16";
    $("outJson").textContent = "{}";
    $("metaLine").textContent = "";
    renderIGTop(null);
    setStatus("idle", "");
  });

  $("runBtn").addEventListener("click", async ()=>{
    const apiBase = $("apiBase").value.trim().replace(/\/+$/,"");
    saveApiBase(apiBase);

    const type = getInputType();
    const value = $("ival").value.trim();

    if(!apiBase || !value){
      alert("API Base URL と入力値を指定してください。");
      return;
    }

    const doIG = $("doIG").checked;
    const endpoint = doIG ? "/interpret" : "/predict";
    const url = apiBase + endpoint;

    const body = {};
	if (type === "smiles") {
	  body.smiles = value;
	} else {
	body.cid = String(value); // CIDは文字列で渡す
	}
	if (doIG) {
	  body.ig_steps = parseInt($("igSteps").value, 10);
	}

    $("runBtn").disabled = true;
    setStatus("running", "");
    $("metaLine").textContent = "";
    renderIGTop(null);

    console.log("[QT] POST", url, body);

    try{
      const r = await postJson(url, body);
      $("outJson").textContent = pretty(r);
      $("metaLine").textContent = summarizeMeta(r);
      renderIGTop(r.ig);
      setStatus("ok", "ok");
    }catch(err){
      const payload = { message: String(err?.message || err), status: err?.status, data: err?.data };
      $("outJson").textContent = pretty(payload);
      setStatus("error", "ng");
      console.error("[QT] ERROR", payload);
      alert("API呼び出しに失敗しました。Console と outJson を確認してください。");
    }finally{
      $("runBtn").disabled = false;
    }
  });

  console.log("[QT] UI ready");
</script>
</body>
</html>
